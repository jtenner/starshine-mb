# Agent Tasks

- [x] coverage: add comprehensive tests for uncovered, important functions (2026-02-08)
  - [x] `./src/binary/decode.mbt`: `decode_unsigned`, `decode_signed`, `Decode for Bool` edge/error paths
  - [x] `./src/dataflow/graph_utils.mbt`: `Graph::make_use` behavior for `Var`, `Expr`, and `Zext` nodes
  - [x] `./src/ir/cfg.mbt`: `build_cfg`, `CFG::successors`, `CFG::predecessors`, `CFG::dominators`
  - [x] `./src/lib/util.mbt` + `./src/lib/texpr.mbt`: `expand_locals`, `tlocals_to_locals`, `TExpr::to_expr`
  - [x] `./src/passes/lift_to_texpr.mbt` + `./src/passes/lower_to_expr.mbt`: lift/lower pass conversion behavior
  - [x] `./src/transformer/transformer.mbt`: `change`, `unchanged`, `ModuleTransformer::walk_module` rewrite/error flow
  - [x] `./src/validate/env.mbt`: `Env::get_label_types`, `Env::expand_blocktype`, `Env::resolve_heaptype_subtype`
  - [x] `./src/wast/module_wast.mbt`: `wast_to_module`, `script_to_wast`, `wast_to_script` error/escape paths

- [ ] switch passes in `./src/passes/*.mbt` to use `IRContext` from `./src/ir/ir_context.mbt`
  - [x] `./src/passes/coalesce_locals.mbt`
  - [x] `./src/passes/code_folding.mbt`
  - [x] `./src/passes/code_pushing.mbt`
  - [x] `./src/passes/const_hoisting.mbt`
  - [x] `./src/passes/constant_field_propagation.mbt`
  - [x] `./src/passes/dataflow_opt.mbt` 
  - [ ] `./src/passes/de_nan.mbt`
  - [x] `./src/passes/directize.mbt`
  - [x] `./src/passes/optimize_casts.mbt`
  - [ ] `./src/passes/remove_unused.mbt`
- [ ] `./src/passes/dataflow_opt.mbt` has about 150+ tests failing because of underlying data structure issues, likely related to the above tasks
- [ ] add binaryen passes to `./src/passes/`. Some of these passes may not make sense in our setting, because they are emscripten specific like `LLVMMemoryCopyFillLowering`, but they may be useful.
  - [ ] Binaryen Pass : Asyncify.cpp
  - [ ] Binaryen Pass : DeAlign.cpp
  - [ ] Binaryen Pass : DeNaN.cpp
  - [x] Binaryen Pass : DeadCodeElimination.cpp
  - [x] Binaryen Pass : DuplicateFunctionElimination.cpp
  - [ ] Binaryen Pass : DuplicateImportElimination.cpp
  - [ ] Binaryen Pass : EncloseWorld.cpp
  - [ ] Binaryen Pass : ExtractFunction.cpp
  - [ ] Binaryen Pass : Flatten.cpp
  - [ ] Binaryen Pass : FuncCastEmulation.cpp
  - [ ] Binaryen Pass : GUFA.cpp
  - [ ] Binaryen Pass : GenerateDynCalls.cpp
  - [ ] Binaryen Pass : GlobalEffects.cpp
  - [ ] Binaryen Pass : GlobalRefining.cpp
  - [ ] Binaryen Pass : GlobalStructInference.cpp
  - [ ] Binaryen Pass : GlobalTypeOptimization.cpp
  - [ ] Binaryen Pass : Heap2Local.cpp
  - [ ] Binaryen Pass : HeapStoreOptimization.cpp
  - [ ] Binaryen Pass : I64ToI32Lowering.cpp
  - [ ] Binaryen Pass : Inlining.cpp
  - [ ] Binaryen Pass : InstrumentBranchHints.cpp
  - [ ] Binaryen Pass : InstrumentLocals.cpp
  - [ ] Binaryen Pass : InstrumentMemory.cpp
  - [ ] Binaryen Pass : Intrinsics.cpp
  - [ ] Binaryen Pass : J2CLItableMerging.cpp
  - [ ] Binaryen Pass : J2CLOpts.cpp
  - [ ] Binaryen Pass : LLVMMemoryCopyFillLowering.cpp
  - [ ] Binaryen Pass : LLVMNontrappingFPToIntLowering.cpp
  - [ ] Binaryen Pass : LegalizeJSInterface.cpp
  - [ ] Binaryen Pass : LimitSegments.cpp
  - [ ] Binaryen Pass : LocalCSE.cpp
  - [ ] Binaryen Pass : LocalSubtyping.cpp
  - [ ] Binaryen Pass : LoopInvariantCodeMotion.cpp
  - [ ] Binaryen Pass : Memory64Lowering.cpp
  - [ ] Binaryen Pass : MemoryPacking.cpp
  - [ ] Binaryen Pass : MergeBlocks.cpp
  - [ ] Binaryen Pass : MergeLocals.cpp
  - [ ] Binaryen Pass : MergeSimilarFunctions.cpp
  - [ ] Binaryen Pass : Metrics.cpp
  - [ ] Binaryen Pass : MinifyImportsAndExports.cpp
  - [ ] Binaryen Pass : MinimizeRecGroups.cpp
  - [ ] Binaryen Pass : Monomorphize.cpp
  - [ ] Binaryen Pass : MultiMemoryLowering.cpp
  - [ ] Binaryen Pass : NoInline.cpp
  - [ ] Binaryen Pass : OnceReduction.cpp
  - [ ] Binaryen Pass : OptimizeAddedConstants.cpp
  - [ ] Binaryen Pass : OptimizeCasts.cpp
  - [ ] Binaryen Pass : OptimizeForJS.cpp
  - [ ] Binaryen Pass : OptimizeInstructions.cpp
  - [ ] Binaryen Pass : Outlining.cpp
  - [ ] Binaryen Pass : PickLoadSigns.cpp
  - [ ] Binaryen Pass : Poppify.cpp
  - [ ] Binaryen Pass : Precompute.cpp
  - [ ] Binaryen Pass : RandomizeBranchHints.cpp
  - [ ] Binaryen Pass : ReReloop.cpp
  - [ ] Binaryen Pass : RedundantSetElimination.cpp
  - [ ] Binaryen Pass : RemoveImports.cpp
  - [ ] Binaryen Pass : RemoveMemoryInit.cpp
  - [ ] Binaryen Pass : RemoveNonJSOps.cpp
  - [ ] Binaryen Pass : RemoveUnusedBrs.cpp
  - [ ] Binaryen Pass : RemoveUnusedModuleElements.cpp
  - [ ] Binaryen Pass : RemoveUnusedNames.cpp
  - [ ] Binaryen Pass : RemoveUnusedTypes.cpp
  - [ ] Binaryen Pass : ReorderFunctions.cpp
  - [ ] Binaryen Pass : ReorderGlobals.cpp
  - [ ] Binaryen Pass : ReorderLocals.cpp
  - [ ] Binaryen Pass : ReorderTypes.cpp
  - [ ] Binaryen Pass : RoundTrip.cpp
  - [ ] Binaryen Pass : SSAify.cpp
  - [ ] Binaryen Pass : SafeHeap.cpp
  - [ ] Binaryen Pass : SeparateDataSegments.cpp
  - [ ] Binaryen Pass : SetGlobals.cpp
  - [ ] Binaryen Pass : SignExtLowering.cpp
  - [ ] Binaryen Pass : SignaturePruning.cpp
  - [ ] Binaryen Pass : SignatureReUse `TExpr` enum for easy conversionfining.cpp
  - [ ] Binaryen Pass : SimplifyGlobals.cpp
  - [ ] Binaryen Pass : SimplifyLocals.cpp
  - [ ] Binaryen Pass : Souperify.cpp
  - [ ] Binaryen Pass : SpillPointers.cpp
  - [ ] Binaryen Pass : StackCheck.cpp
  - [ ] Binaryen Pass : StringLifting.cpp
  - [ ] Binaryen Pass : StringLowering.cpp
  - [ ] Binaryen Pass : Strip.cpp
  - [ ] Binaryen Pass : StripEH.cpp
  - [ ] Binaryen Pass : StripTargetFeatures.cpp
  - [ ] Binaryen Pass : TraceCalls.cpp
  - [ ] Binaryen Pass : TranslateEH.cpp
  - [ ] Binaryen Pass : TrapMode.cpp
  - [ ] Binaryen Pass : TupleOptimization.cpp
  - [ ] Binaryen Pass : TypeFinalizing.cpp
  - [ ] Binaryen Pass : TypeGeneralizing.cpp
  - [ ] Binaryen Pass : TypeMerging.cpp
  - [ ] Binaryen Pass : TypeRefining.cpp
  - [ ] Binaryen Pass : TypeSSA.cpp
  - [ ] Binaryen Pass : Unsubtyping.cpp
  - [ ] Binaryen Pass : Untee.cpp
  - [ ] Binaryen Pass : Vacuum.cpp
- [ ] Improve `./src/lib/show.mbt` trait definitions for pretty printing module outputs
- [ ] Implement `./src/wast/*.mbt` to be able to parse and pretty print the s-expression text format of WebAssembly
  - [ ] Add more complete tests
  - [ ] Fix pretty printing of modules to match the s-expression text format of WebAssembly
  - [ ] WAST to WAT functions
  - [ ] WAST to WASM types functions (Use `TExpr` enum for easy conversion)
- [ ] Implement `./src/wat/*.mbt` to be able to parse and pretty print text format standard for wasm 3.0
  - [ ] Lexer and tests
  - [ ] Parser and tests
  - [ ] Printer and tests
  - [ ] WAT to WAST functions
  - [ ] WAT to WASM types functions (Use `Instruction` enum for easy conversion)
- [ ] `./src/transformer/transformer.mbt` needs tests

- [x] resolve current `moon check` warnings (was 18, now 0)
  - [x] `./src/ir/imports.mbt`: remove unused `TransformerResult` import
  - [x] `./src/ir/ssa_optimize_tests.mbt`: remove/consume unused `right` variable in test pattern
  - [x] `./src/ir/types.mbt`: either construct `Load` in IR generation or remove/deprecate the unused `Load` constructor
  - [x] `./src/ir/types.mbt`: remove or use the unused `instr_id` field in `Get(LocalIdx, Int, Int)`
  - [x] `./src/lib/types.mbt`: remove or repurpose unused local `Option[T]` enum definition
  - [x] `./src/passes/coalesce_locals.mbt`: remove or use `is_loop_header`
  - [x] `./src/passes/optimize_casts.mbt`: remove or use `CastOptState::with_locals`
  - [x] `./src/wast/parser.mbt`: remove or implement currently-unused variants (`V128`, `RefExtern`, `UnexpectedEof`, `InvalidType`) and helper functions (`error`, `try_parse_simd_shape`)
  - [x] `./src/wast/types.mbt`: remove or use currently-unused variants (`Warning`, `Func`, `Extern`) and `KeywordEntry`
- [ ] add a CI/job gate that runs `moon check` and fails on warnings regression
