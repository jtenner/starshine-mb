name: "Examples CLI Native"

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "examples/**"
      - "scripts/run_examples_cli_smoke.sh"
      - "scripts/check_examples_cli_native_workflow.sh"
      - "src/cmd/**"
      - "src/cli/**"
      - "src/passes/**"
      - "src/wast/**"
      - "src/wat/**"
      - "src/binary/**"
      - "src/validate/**"
      - "moon.mod.json"
      - "moon.pkg.json"
      - ".github/workflows/examples-cli-native.yml"
  push:
    branches:
      - main
    paths:
      - "examples/**"
      - "scripts/run_examples_cli_smoke.sh"
      - "scripts/check_examples_cli_native_workflow.sh"
      - "src/cmd/**"
      - "src/cli/**"
      - "src/passes/**"
      - "src/wast/**"
      - "src/wat/**"
      - "src/binary/**"
      - "src/validate/**"
      - "moon.mod.json"
      - "moon.pkg.json"
      - ".github/workflows/examples-cli-native.yml"

jobs:
  examples-cli-native:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      WASM_TOOLS_VERSION: "1.239.0"
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Verify native CI wasm-tools workflow contract
        run: |
          bash scripts/check_examples_cli_native_workflow.sh

      - name: Install native differential validator tools
        run: |
          sudo apt-get update
          sudo apt-get install -y binaryen

      - name: Cache wasm-tools cargo install artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/wasm-tools
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-wasm-tools-${{ env.WASM_TOOLS_VERSION }}

      - name: Install wasm-tools (if cache miss)
        run: |
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          if [ ! -x "$HOME/.cargo/bin/wasm-tools" ]; then
            cargo install wasm-tools --locked --version "$WASM_TOOLS_VERSION"
          fi

      - name: Run examples CLI smoke checks (native target)
        run: |
          bash scripts/run_examples_cli_smoke.sh

      - name: Run native fuzz harness differential test
        run: |
          moon test --target native \
            -p jtenner/starshine/cmd \
            -f fuzz_harness_test.mbt \
            -F "*differential_validate_wasm agrees with installed wasm-tools and binaryen validators*"
